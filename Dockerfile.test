# syntax=docker/dockerfile:1

# Dockerfile for CI/test environment
ARG RUBY_VERSION=3.3.9
FROM docker.io/library/ruby:$RUBY_VERSION-slim

WORKDIR /rails

# Install system dependencies including Chrome for system specs
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
      build-essential \
      curl \
      git \
      gnupg \
      libpq-dev \
      libvips \
      libyaml-dev \
      node-gyp \
      pkg-config \
      postgresql-client \
      python-is-python3 && \
    curl -fsSL https://dl.google.com/linux/linux_signing_key.pub | gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg && \
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] https://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list && \
    apt-get update -qq && \
    apt-get install --no-install-recommends -y google-chrome-stable && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Install Node.js and Yarn
ARG NODE_VERSION=20.18.1
ARG YARN_VERSION=1.22.21
ENV PATH=/usr/local/node/bin:$PATH
RUN curl -sL https://github.com/nodenv/node-build/archive/master.tar.gz | tar xz -C /tmp/ && \
    /tmp/node-build-master/bin/node-build "${NODE_VERSION}" /usr/local/node && \
    npm install -g yarn@$YARN_VERSION && \
    rm -rf /tmp/node-build-master

# Set test environment
ENV RAILS_ENV="test" \
    BUNDLE_PATH="/usr/local/bundle"

# Install gems (including dev/test groups)
COPY Gemfile Gemfile.lock ./
RUN bundle install --jobs 4

# Install node modules
COPY package.json yarn.lock ./
RUN yarn install

# Copy application code
COPY . .

# Build CSS assets
RUN yarn build:css

# Default command
CMD ["bundle", "exec", "rspec"]
